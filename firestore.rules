rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================
    //  Helper Functions
    // ===================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isVerifiedUser() {
      return isSignedIn() && request.auth.token.email_verified;
    }
    
    function isAdmin() {
      // Check if the user has the 'admin' or 'owner' role in their profile
      return isSignedIn() &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner']);
    }
    
    function canCreateUserProfile(userId) {
      let isCreatingOwnDoc = isOwner(userId);
      let resourceData = request.resource.data;
      let hasRequiredFields = 'firstName' in resourceData && 'lastName' in resourceData && 'email' in resourceData;
      let isValidRole = resourceData.role in ['traveler', 'admin', 'owner'];
      
      return isCreatingOwnDoc && hasRequiredFields && isValidRole;
    }
    
    function isValidUpdateData(allowedFields) {
        return request.resource.data.keys().hasOnly(allowedFields);
    }
    
    // ===================================
    //  Collection Rules
    // ===================================

    // --- Users Collection ---
    match /users/{userId} {
      // READ: Any signed-in user can read any user's profile. Admin can read all.
      allow read: if isSignedIn();
      
      // CREATE: A user can create their own profile document.
      allow create: if canCreateUserProfile(userId);
      
      // UPDATE: A user can only update their own profile, or an admin can update any profile.
      allow update: if isAdmin() || (isOwner(userId) && isValidUpdateData([
          'firstName', 'lastName', 'phoneNumber', 'role', 'isDeactivated', 
          'vehicleType', 'vehicleModel', 'vehicleYear', 'vehiclePlateNumber', 
          'vehicleCapacity', 'vehicleImageUrls', 'primaryRoute', 'paymentInformation',
          'bagsPerSeat', 'numberOfStops', 'updatedAt'
      ]));
      
      // DELETE: A user can delete their own profile document, or an admin can delete any.
      allow delete: if isAdmin() || isOwner(userId);

      // --- Notifications Subcollection ---
      match /notifications/{notificationId} {
        // Only the owner of the parent user document can access their notifications.
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }

    // --- Trips Collection ---
    match /trips/{tripId} {
        allow read: if true;
        allow create: if isOwner(request.resource.data.userId);

        allow update: if isAdmin() || isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.carrierId) ||
                         isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.userId);

        allow delete: if isAdmin() || (isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.userId) &&
                         (get(/databases/$(database)/documents/trips/$(tripId)).data.status == 'Awaiting-Offers' ||
                          get(/databases/$(database)/documents/trips/$(tripId)).data.status == 'Planned'));
        
        match /offers/{offerId} {
            allow read: if isSignedIn();
            allow create: if isOwner(request.resource.data.carrierId);
            allow update: if isOwner(get(/databases/$(database)/documents/trips/$(tripId)).data.userId);
            allow delete: if false;
        }
    }

    // --- Bookings Collection ---
    match /bookings/{bookingId} {
        allow read: if isAdmin() || isOwner(resource.data.userId) || isOwner(resource.data.carrierId);
        allow create: if isOwner(request.resource.data.userId);
        allow update: if isAdmin() || isOwner(resource.data.userId) || isOwner(resource.data.carrierId);
        allow delete: if isAdmin();
    }
    
    // --- Ratings Collection ---
    match /ratings/{ratingId} {
        allow read: if isSignedIn();
        allow create: if isOwner(request.resource.data.userId);
        allow update, delete: if false;
    }
    
    // --- Chats Collection ---
    match /chats/{chatId} {
      allow read, write: if isSignedIn() && request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if isOwner(request.resource.data.senderId) && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow update, delete: if false;
      }
    }

    // --- Transfer Requests Collection ---
    match /transferRequests/{transferRequestId} {
        allow read: if isOwner(resource.data.fromCarrierId) || isOwner(resource.data.toCarrierId);
        allow create: if isOwner(request.resource.data.fromCarrierId);
        allow update: if isOwner(resource.data.toCarrierId);
        allow delete: if false;
    }

    // --- Analytics Collection (write-only) ---
    match /analytics_events/{eventId} {
        allow read, update, delete: if false;
        allow create: if true;
    }
  }
}
